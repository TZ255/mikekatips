<!-- Firebase Auth Script for Register -->
<script type="module">
    import { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Initialize Firebase
    const app = getApps().length === 0 ? initializeApp(window.firebaseConfig) : getApps()[0];
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    //type module are not global by default... attaching window.signInWithGoogle to window enable us to call signInWithGoogle() anywhere in this case the button onclick calls it
    window.signInWithGoogle = async function() {
        const btn = document.getElementById('googleSignInBtn');
        const originalContent = btn.innerHTML;
        
        try {
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i><span>Inajisajili...</span>';
            
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            const idToken = await user.getIdToken();

            // Send token to backend
            const response = await fetch('/auth/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ idToken })
            });

            const data = await response.json();
            
            if (data.success) {
                window.location.href = '/';
            } else {
                throw new Error(data.message || 'Registration failed');
            }
        } catch (error) {
            // Reset button state
            btn.disabled = false;
            btn.innerHTML = originalContent;
            
            let errorMessage = 'Hitilafu katika kujisajili. Jaribu tena.';
            
            if (error.code === 'auth/popup-closed-by-user') {
                errorMessage = 'Ulisitisha kujisajili. Jaribu tena.';
            } else if (error.code === 'auth/popup-blocked') {
                errorMessage = 'Popup imezuiwa na browser. Ruhusu popup na jaribu tena.';
            } else if (error.code === 'auth/network-request-failed') {
                errorMessage = 'Tatizo la mtandao. Angalia muunganisho wako.';
            }
            
            // Show error message
            showError(errorMessage);
        }
    }

    function showError(message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll('.alert-danger');
        existingAlerts.forEach(alert => alert.remove());
        
        // Add new alert
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const flashContainer = document.querySelector('.card-body');
        flashContainer.insertAdjacentHTML('afterbegin', alertHtml);
    }
</script>